![postgresql](https://diamanti.com/wp-content/uploads/2019/10/postgresql.png)
![mvn](https://habrastorage.org/webt/5a/f3/22/5af322981410c538019113.png)


# SIMPLE SHOP

## !!!!!!!!! сделать URL, USER, PASSWORD !!!!!!!!!!!!!!
Simple shop - это простой сервис для работы с данными о покупателях N-го магазина, который на основе входных параметров (аргументов командной строки), типа операции и входного файла - извлекает необходимые данные из БД и формирует реузльтат обработки в выходной файл. Ошибки обрабатываются и фиксируются в выходной файл.

**Общая информация:**
* Используемый стек: java 8, PostgerSQL, Maven
* Входные параметры: тип операции, путь к входному файлу, путь к файлу реузльтата
* Формат файлов: JSON
* Готовый набор данных для тестирования (дамп БД, входные файлы) лежат в проекте (см далее)
* Инструкция по сборке далее в этом руководстве

**Структура данных**
* Покупатели (имя, фамилия)
* Товары (название, цена)
* Покупки (покупатель, товар, дата покупки)

**Интерфейс включает в себя возможности такие как:**

## 1. Поиск покупателей по критериям (search)
Во входном файле передаётся список критериев для поиска покупателей. Результат операции - списки покупателей для каждого критерия из запроса. Порядок списков такой же как в запросе, порядок покупателей в списке - произвольный. Критерии могут повторяться.

Критерии:
* Фамилия - поиск покупателей с этой фамилией
* Название товара и число раз - поиск покупателей, купивших этот товар
не менее, чем указанное число раз
* Минимальная и максимальная стоимость всех покупок - поиск покупателей,
у которых общая стоимость всех покупок за всё время попадает в интервал
* Число пассивных покупателей - поиск покупателей, купивших меньше всего 
товаров. Возвращается не более, чем указанное число покупателей.

**Пример запроса:**
````
& java -jar target/simple_shop-1.0-SNAPSHOT-jar-with-dependencies.jar search exampleInputFile/exampleInputSearch.json exampleOutputFile/outputSearch.json
````

**Пример входных данных (в проекте: exampleInputFile/exampleInputSearch.json) :**
````
{
  "criterias" : [
    {"last_name" : "Иванов"}, // Фамилия
    {"product_name" : "Миниральная вода", "min_times" : 3}, // Название товара и число раз
    {"min_expenses" : 10, "max_expenses" : 250}, // Минимальная и максимальная стоимость всех покупок
    {"bad_customers" : 2}, // Число пассивных покупателей
    {"last_name" : "Иванович"} 
  ]
}
````

**При условии, что изначально БД сформирована как в файле src/main/resources/create.sql**
````
 id | first_name | last_name |       name       | price |    date    
----+------------+-----------+------------------+-------+------------
  1 | Даша       | Иванова   | Миниральная вода |    10 | 2020-01-16
  2 | Даша       | Иванова   | Миниральная вода |    10 | 2020-01-16
  3 | Даша       | Иванова   | Миниральная вода |    10 | 2020-01-16
  4 | Даша       | Иванова   | Миниральная вода |    10 | 2020-01-16
  5 | Даша       | Иванова   | Миниральная вода |    10 | 2020-01-16
  6 | Иван       | Иванов    | Миниральная вода |    10 | 2020-01-16
  7 | Иван       | Иванов    | Миниральная вода |    10 | 2020-01-16
  8 | Иван       | Иванов    | Сок              |    15 | 2020-01-16
  9 | Иван       | Иванов    | Чай              |   200 | 2020-01-16
 10 | Иван       | Иванов    | Лимонад          |     5 | 2020-01-16
 11 | Иван       | Иванович  | Сок              |    15 | 2020-01-01
 12 | Иван       | Иванович  | Чай              |   200 | 2020-01-01
 13 | Иван       | Иванович  | Лимонад          |     5 | 2020-01-01
 14 | Даша       | Иванова   | Сок              |    15 | 2020-01-30
 15 | Даша       | Иванова   | Чай              |   200 | 2020-01-30
 16 | Даша       | Иванова   | Лимонад          |     5 | 2020-01-30

````

**Вывод будет таким: (файл exampleOutputFile/outputSearch.json)**
````
{
	"type": "search", // Тип результата
	"results": [ // Списки покупателей
		{
		"criteria": {
			"last_name": "Иванов" // Критерий из запроса
		},
		"results": [{
			"first_name": "Иван", // Имя найденного покупателя
			"last_name": "Иванов" // Фамилия найденного покупателя
		}, {
			"first_name": "Александр",
			"last_name": "Иванов"
		}]
	}, {
		"criteria": {
			"product_name": "Миниральная вода",
			"min_times": 3
		},
		"results": [{
			"first_name": "Даша",
			"last_name": "Иванова"
		}]
	}, {
		"criteria": {
			"min_expenses": 10.0,
			"max_expenses": 250.0
		},
		"results": [{
			"first_name": "Иван",
			"last_name": "Иванович"
		}, {
			"first_name": "Иван",
			"last_name": "Иванов"
		}]
	}, {
		"criteria": {
			"bad_customers": 2
		},
		"results": [{
			"first_name": "Иван",
			"last_name": "Иванович"
		}, {
			"first_name": "Иван",
			"last_name": "Иванов"
		}]
	}, {
		"criteria": {
			"last_name": "Иванович"
		},
		"results": [{
			"first_name": "Иван",
			"last_name": "Иванович"
		}]
	}]
}
````
## 2. Вывод статистики за период (stat)
Во входном файле передаётся интервал дат сбора статистики. Результат операции- статистика по покупателям за период из двух дат, включительно, без выходных.

**Пример запроса:**
````
& java -jar target/simple_shop-1.0-SNAPSHOT-jar-with-dependencies.jar stat exampleInputFile/exampleInputStat.json exampleOutputFile/outputStat.json
````

**Пример входных данных (в проекте: exampleInputFile/exampleInputStat.json) :**
````
{
  "start_date" : "2020-01-14", // дата с которой начинается сбор статистики (этот день включается в результат)
  "end_date" : "2020-01-26" // дата по которую собирается сбор статистики (этот день тоже включается в результат)
}
````

**При условии, что изначально БД сформирована как в файле src/main/resources/create.sql**

**Вывод будет таким: (файл exampleOutputFile/outputStat.json)**
````
{
	"type": "stat", // тип результата
	"totalDays": 13, // общее число дней за период из двух дат, 
                   // включительно, без выходных
	"customers": [ // данные по покупателям за этот период, упорядоченные по общей стоимости покупок по убыванию
  { // данные первого покупателя
		"name": "Иван Иванов", // имя и фамилия покупателя
		"purchases": [ // список всех уникальных товаров, купленных окупателем за этот период, упорядоченных по сумарной стоимости по убыванию
    {
			"name": "Чай", // наименование товара
			"price": 200.0 // цена
		}, {
			"name": "Миниральная вода",
			"price": 20.0
		}, {
			"name": "Сок",
			"price": 15.0
		}, {
			"name": "Лимонад",
			"price": 5.0
		}],
		"totalExpenses": 240.0 // общая стоимость всех покупок этого покупателя за период (т.е. сумма всех стоимостей покупок всех товаров)
	}, { // данные второго покупателя
		"name": "Даша Иванова",
		"purchases": [{
			"name": "Миниральная вода",
			"price": 50.0
		}],
		"totalExpenses": 50.0
	}],
	"totalExpenses": 290.0, // сумма покупок всех покупателей за период
	"avgExpenses": 145.0 // средние затраты всех покупателей за период
}
````
**Сообщение об ошибке: (файл error.json)**
Если запрос не был исполнен корректно, то выходной файл будет примерно следующим:
````
{
	"type": "error",
	"message": "ERROR: syntax error at or near \"pur\"\n  Позиция: 217"
}
````
Или если, например, таблица ещё не создана, то вывод будет следующий:
````
{
	"type":"error",
	"message":"ERROR: relation \"buyer\" does not exist\n  Позиция: 35"
}
````

## Процесс сборки

### Используемые версии

* Ubuntu 18.04.4 LTS
* openjdk version 1.8.0_162
* Apache Maven 3.5.2
* PostgreSQL 10.3

### Начало работы с postgreSQL
После установки postgers нужной версии необходимо создать пользователя, БД для пользователя и установить пароль для пользователя

1. Создание нового пользователя
````
$ createuser --interactive;
Enter name of role to add: vikula
Shall the new role be a superuser? (y/n) y
````
2. Вход в консоль (из под учётки автоматически созданного пользователя 'postgres')
````
$ sudo -u postgres psql
````
3. Регистрируем нового пользователя в Unix:
````
$ sudo adduser vikula;
````
4. Создание БД для пользователя (имя должно совпадать с именем пользователя)
````
# CREATEDB vikula;
````
5. Изменение пароля для пользователя
````
# ALTER USER vikula WITH password '111'
````
6. Выход из консоли
````
# \q
````
7. Итог, теперь вход в консоль будет осуществляться с помощью команды
````
$ psql -h localhost nameDB nameUser
````
### Дамп БД в файле src/main/resources/create.sql
После выполнения скрипта будут созданы нужные таблицы и добавлены тестовые данные.

### SQL команды, которые используются в программе можно найти в файле src/main/resources/myCommand.sql

### Сборка проекта
````
$ mvn compile # сборка проекта
$ mvn package # упаковка проекта
$ java -jar target/simple_shop-1.0-SNAPSHOT-jar-with-dependencies.jar instruction input.json output.json # запуск проекта
````
Где 'instruction' - тип операции, которую нужно выполнить (search или stat),
input.json - входной файл, output.json - выходной файл.
